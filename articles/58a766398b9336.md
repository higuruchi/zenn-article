---
title: "ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã¨ä¾å­˜é–¢ä¿‚é€†è»¢ã®æ³•å‰‡"
emoji: "ğŸ•"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: []
published: false
---

## ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ä»•æ§˜

ä»Šå›ä½œæˆã—ãŸã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã¯ãƒ¦ãƒ¼ã‚¶åã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å«ã‚“ã ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’å—ã‘ã‚‹ã¨ã€ãƒ¦ãƒ¼ã‚¶åã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã®ãƒšã‚¢ãŒæ­£ã—ã„ã‹æ¤œè¨¼ã—ã€æ­£ã—ã„å ´åˆã¯ãƒˆãƒ¼ã‚¯ãƒ³ã‚’è¿”ã™ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã§ã™ã€‚ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã¯ä»¥ä¸‹ã®ãƒªãƒ³ã‚¯ã«ã‚ã‚Šã¾ã™ã€‚

https://github.com/higuruchi/certification-app

ä»¥ä¸‹ã¯å®Ÿè¡Œæ™‚ã®ãƒ‡ãƒ¢ã§ã™ã€‚

```bash
$ curl -w '\n' 'http://<IP Address>:<Port>/' --data 'name=higuruchi&password=pass' -XPOST
{"token":"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJhZG1pbiI6dHJ1ZSwiZXhwIjoxNjMxNjgxODk3fQ.YEWrN5T2rQyferN2kt2V3up3fW5N030jlDphkzXx7JU"}
$  curl -w '\n' 'http://<IP Address>:<Port>/' --data 'name=higuruchi&password=faultpass' -XPOST
{"message":"unauthorized"}
```

### å‡¦ç†ã®æµã‚Œ

![](https://storage.googleapis.com/zenn-user-upload/c62c2a28df8a-20211206.png)

## ä½¿ç”¨æŠ€è¡“

- Go 1.17
    - Echo(https://echo.labstack.com/)
    - Wire(https://github.com/google/wire)
- MySQL Ver 8.0.26

## ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã£ã¦ï¼Ÿ

ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã¨ã¯ãã‚Œãã‚Œã®å±¤ã‚’åˆ†é›¢ã—ã€ä¾å­˜ã®æµã‚Œã‚’å¤–ã‹ã‚‰ä¸­ã ã‘ã®ä¸€æ–¹å‘ã«ã™ã‚‹ã“ã¨ã§DBã‚„ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã‹ã‚‰ã®ç‹¬ç«‹æ€§ã‚’ç¢ºä¿ã™ã‚‹ã“ã¨ã‚’ç›®çš„ã¨ã—ãŸã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã§ã™ã€‚ä»¥ä¸‹ã®å›³ãŒæœ‰åã§ã™ãŒã€æ­£ç¢ºã«ï¼”å±¤ã§ã‚ã‚‹å¿…è¦ã¯ãªãã€ã€Œä¾å­˜æ€§ã®ãƒ«ãƒ¼ãƒ«ã€ã€ã€Œé–¢å¿ƒã®åˆ†é›¢ã€ã€ã€Œä¾å­˜é–¢ä¿‚é€†è»¢ã®æ³•å‰‡ã€ãŒé‡è¦ã¨ã•ã‚Œã¦ã„ã¾ã™ã€‚

![](https://storage.googleapis.com/zenn-user-upload/1de1a18e5e52-20211206.jpeg)

## ãã‚Œãã‚Œã®å±¤ã®è§£èª¬

### ã€€ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹é€ 

./internalä»¥ä¸‹ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒãã‚Œãã‚Œã®å±¤ã«å¯¾å¿œã—ã¦ã„ã¾ã™ã€‚

```bash
â¯ tree
.
â”œâ”€â”€ README.md
â”œâ”€â”€ cmd
â”‚Â Â  â””â”€â”€ main.go
â”œâ”€â”€ go.mod
â”œâ”€â”€ go.sum
â””â”€â”€ internal
    â”œâ”€â”€ config
    â”‚Â Â  â””â”€â”€ cmd
    â”‚Â Â      â””â”€â”€ root.go
    â”œâ”€â”€ di
    â”‚Â Â  â”œâ”€â”€ wire.go
    â”‚Â Â  â””â”€â”€ wire_gen.go
    â”œâ”€â”€ externalinterface
    â”‚Â Â  â”œâ”€â”€ database
    â”‚Â Â  â”‚Â Â  â”œâ”€â”€ database.go
    â”‚Â Â  â”‚Â Â  â””â”€â”€ table.sql
    â”‚Â Â  â””â”€â”€ server
    â”‚Â Â      â””â”€â”€ server.go
    â”œâ”€â”€ interfaceadapter
    â”‚Â Â  â”œâ”€â”€ controller
    â”‚Â Â  â”‚Â Â  â””â”€â”€ user_controller.go
    â”‚Â Â  â””â”€â”€ repository
    â”‚Â Â      â”œâ”€â”€ model
    â”‚Â Â      â”‚Â Â  â””â”€â”€ user_model.go
    â”‚Â Â      â”œâ”€â”€ user_repository.go
    â”‚Â Â      â”œâ”€â”€ util.go
    â”‚Â Â      â””â”€â”€ worker
    â”‚Â Â          â””â”€â”€ database_handler.go
    â””â”€â”€ usecase
        â”œâ”€â”€ model
        â”‚Â Â  â””â”€â”€ user_model.go
        â”œâ”€â”€ repository
        â”‚Â Â  â””â”€â”€ user_repository.go
        â””â”€â”€ user_usecase.go

16 directories, 18 files
```


### Enterprise Business Rules

ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯ã‚’è¡¨ç¾ã™ã‚‹EntityãŒæ‰€å±ã™ã‚‹ãƒ¬ã‚¤ãƒ¤ãƒ¼ã§ã™ã€‚
ä»Šå›ã®ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã§ã¯åˆ©ç”¨ã—ã¦ã„ã¾ã›ã‚“ãŒã€é€šå¸¸ã¯ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã«ã¨ã£ã¦é‡è¦ãªãƒ‡ãƒ¼ã‚¿ã®æ§‹é€ ä½“ãªã©ãŒå®šç¾©ã•ã‚Œã¾ã™ã€‚

### Application Business Rules

EntityãŒæŒã¤æŒ¯ã‚‹èˆã„ã‚’è¡¨ç¾ã™ã‚‹ãŸã‚ã®ãƒ¬ã‚¤ãƒ¤ãƒ¼ã§ã€Entityã«æ‰€å±ã™ã‚‹ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã¨å”èª¿ã—ãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹ã‚’é”æˆã—ã¾ã™ã€‚

ä»Šå›ã®ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®å ´åˆã€```./internal/usecase```ä»¥ä¸‹ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«å½“ãŸã‚Šã¾ã™ã€‚

ãƒ¦ãƒ¼ã‚¶åã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‹ã‚‰ã€ãƒ­ã‚°ã‚¤ãƒ³ãŒã§ãã‚‹ã‹ã©ã†ã‹ã‚’æ¤œè¨¼ã™ã‚‹Loginãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹ã‚’å®šç¾©ã—ã¦ã„ã¾ã™ã€‚

```FindUser```ãƒ¡ã‚½ãƒƒãƒ‰ã¯```./internal/usecase/repository/user_repository.go```ã®```UserRepository```ã‚¤ãƒ³ã‚¿ãƒ•ã‚§ãƒ¼ã‚¹ã«å®šç¾©ã•ã‚Œã¦ã„ã¾ã™ã€‚

### Interface Adapter (interfaceadapter)

Frameworks & Driversã®å±¤ã‹ã‚‰æ¥ãŸãƒ‡ãƒ¼ã‚¿ã‚’å†…å´ã®å±¤ã§æ‰±ãˆã‚‹ãƒ‡ãƒ¼ã‚¿ã®å¤‰æ›ã«ã™ã‚‹å½¹å‰²ã‚’æœãŸã—ã¾ã™ã€‚

### Frameworks & Drivers (externalinterface)

ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®ãƒ‰ãƒ©ã‚¤ãƒãƒ¼ã‚„Webãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ãªã©ã®å¤–éƒ¨ã¨ã®é€£æºã®å½¹å‰²ã‚’æœãŸã™ã‚³ãƒ¼ãƒ‰ãŒæ‰€å±ã—ã¾ã™ã€‚
ã“ã®ãƒ¬ã‚¤ãƒ¤ãƒ¼ã§ã¯åˆ©ç”¨ã™ã‚‹ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ã‚„ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã«ã‚ˆã£ã¦å¤§ããå®Ÿè£…ãŒç•°ãªã‚Šã¾ã™ã€‚ãã®ãŸã‚ã€ä»–ã®å±¤ã®ã‚³ãƒ¼ãƒ‰ã¨æ¯”è¼ƒã—ã¦é »ç¹ã«å¤‰æ›´ã•ã‚Œã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚
ã¾ãŸã€ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã®ãƒ¦ãƒ¼ã‚¶ã‚¤ãƒ³ã‚¿ãƒ•ã‚§ãƒ¼ã‚¹ã¨ãªã‚‹ã‚³ãƒ¼ãƒ‰ã‚‚ã“ã®å±¤ã«æ‰€å±ã—ã¾ã™ã€‚

### ä¾å­˜é–¢ä¿‚é€†è»¢ã®æ³•å‰‡

ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã¯ä¸‹å›³ã®ã‚ˆã†ã«å¤–ã®å±¤ã‹ã‚‰å†…ã®å±¤ã¸ã®ä¾å­˜ã«é™å®šã—ã¦ã„ã‚‹ã®ã§ã™ãŒã€

![](https://storage.googleapis.com/zenn-user-upload/98b0989632f0-20211228.png)

Interface Adaterå±¤ã‹ã‚‰External Interfaceå±¤ã®DBã«ã‚¢ã‚¯ã‚»ã‚¹ã—ãŸã„å ´åˆãªã©ã®ã‚ˆã†ã«ã€å†…å´ã‹ã‚‰å¤–å´ã¸ã®ä¾å­˜é–¢ä¿‚ã‚’ç™ºç”Ÿã•ã›ãŸã„å ´åˆãŒã‚ã‚Šã¾ã™ã€‚
ãã®éš›ã«ç›´æ¥ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ãªã©ã«ã‚¢ã‚¯ã‚»ã‚¹ã‚’ã—ãŸå ´åˆã€å¤–ã‹ã‚‰å†…å´ã®ã¿ã®ä¾å­˜ã¨ã„ã†åˆ¶ç´„ã‚’ç ´ã‚Šã€é©åˆ‡ã§ãªã„ä¾å­˜é–¢ä¿‚ãŒç™ºç”Ÿã—ã¾ã™ã€‚
ã“ã‚Œã‚’è§£æ¶ˆã™ã‚‹ãŸã‚ã«ä¾å­˜é–¢ä¿‚é€†è»¢ã®æ³•å‰‡ã‚’ç”¨ã„ã¾ã™ã€‚

![](https://storage.googleapis.com/zenn-user-upload/f7ee48902648-20211228.png)

ã“ã‚Œã«ã‚ˆã£ã¦ã€ãƒ—ãƒ­ã‚°ãƒ©ãƒ ãªã„ã®ä¾å­˜é–¢ä¿‚ã‚’ä¸€æ–¹å‘ã«ä¿ã¤ã“ã¨ãŒã§ãã€externalinterfaceå±¤ã®ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚’ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã¨ã—ã¦æ‰±ã†ã“ã¨ãŒã§ãã‚‹ãŸã‚ã€DBã‚’å¤‰æ›´ã‚„ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã®å¤‰æ›´ã«ã‚‚æŸ”è»Ÿã«å¯¾å¿œã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

ä¾å­˜é–¢ä¿‚é€†è»¢ã®æ³•å‰‡ã‚’èª¬æ˜ã™ã‚‹ãŸã‚ã«ã€ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«é–“ã®ä¾å­˜é–¢ä¿‚ãŒä¸‹å›³ã®ã‚ˆã†ãªå ´åˆã‚’è€ƒãˆã¾ã™ã€‚
mainãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«å†…ã§MA1ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’å‘¼ã³å‡ºã—ã€MA1ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«å†…ã§MB1ã‚’å‘¼ã³å‡ºã—ã¦ã„ã¾ã™ã€‚

![](https://storage.googleapis.com/zenn-user-upload/81536c4191d2-20211228.jpg)

ã“ã®ã‚ˆã†ãªä¾å­˜é–¢ä¿‚ã®å ´åˆã€MB1ã®ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã‚’å¤‰æ›´ã—ãŸéš›ã«MA1ã®ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã‚‚å¤‰æ›´ã‚’ã—ãªã‘ã‚Œã°ãªã‚‰ãªã„å¯èƒ½æ€§ãŒç™ºç”Ÿã—ã¾ã™ã€‚

ã—ã‹ã—ã€ã“ã“ã§ãƒãƒªãƒ¢ãƒ¼ãƒ•ã‚£ã‚ºãƒ ã‚’åˆ©ç”¨ã—ã€MB1ã‚’å‘¼ã³å‡ºã™ã“ã¨ã«ã‚ˆã£ã¦ã€ä¾å­˜é–¢ä¿‚ã‚’é€†è»¢ã•ã›ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

![](https://storage.googleapis.com/zenn-user-upload/df47bdf7f0b1-20211228.jpg)

MB1ã‚’ã‚¤ãƒ³ã‚¿ãƒ•ã‚§ãƒ¼ã‚¹ã«ä¾å­˜ã•ã›ã€MA1ã¯ã‚¤ãƒ³ã‚¿ãƒ•ã‚§ãƒ¼ã‚¹ã‚’ä»‹ã—ã¦MB1ã®ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’å‘¼ã³å‡ºã™ã“ã¨ã§ã€MB1ã‚’ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã¨ã—ã¦æ‰±ã†ã“ã¨ãŒã§ãã¾ã™ã€‚ãã®ãŸã‚ã€MB1å†…ã®ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã‚’å¤‰æ›´ã—ãŸã¨ã—ã¦ã‚‚MA1ã«å½±éŸ¿ã‚’ä¸ãˆã‚‹ã“ã¨ã¯ãªãã€ä¾å­˜é–¢ä¿‚ã«ã‚ˆã£ã¦ç”Ÿã˜ã‚‹ãƒã‚°ã‚„ãƒ—ãƒ­ã‚°ãƒ©ãƒ ç ´å£Šã‚’é˜²ã„ã§ãã‚Œã¾ã™ã€‚

![](https://storage.googleapis.com/zenn-user-upload/ddd131e19b91-20211228.jpg)

ä»Šå›ä½œæˆã—ãŸã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã§ã€ä¾å­˜é–¢ä¿‚é€†è»¢ã®æ³•å‰‡ã‚’åˆ©ç”¨ã—ã¦ã„ã‚‹ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã®ä¸€ä¾‹ã‚’ã‚ã’ã¾ã™ã€‚
usecaseå±¤ã‹ã‚‰interfaceadapterå±¤ã®ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’å‘¼ã³å‡ºã™éš›ã®å‡¦ç†ã§ã™ã€‚

![](https://storage.googleapis.com/zenn-user-upload/921ab067b208-20211228.jpg)

```Go:./internal/usecase/repository/user_repository.go
// usecaseå±¤ã‹ã‚‰å‘¼ã³å‡ºã™ãŸã‚ã«interfaceadapterå±¤ã®ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆãŒæº€ãŸã™ã¹ãã‚¤ãƒ³ã‚¿ãƒ•ã‚§ãƒ¼ã‚¹ã‚’å®šç¾©ã—ã¦ã„ã‚‹
package repository

import (
	"github.com/higuruchi/certification-app/internal/usecase/model"
)

type UserRepository interface {
	FindUser(model.User) (bool, error)
}
```

```Go:./internal/user_usecase.go
package usecase

import (
	"fmt"
	"github.com/higuruchi/certification-app/internal/usecase/repository"
	"github.com/higuruchi/certification-app/internal/usecase/model"
)

type userUsecase struct {
    // interfaceadapterå±¤ã®ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’å‘¼ã³å‡ºã™ãŸã‚ã®ã‚¤ãƒ³ã‚¿ãƒ•ã‚§ãƒ¼ã‚¹ãŒæ§‹é€ ä½“ã®ãƒ¡ãƒ³ãƒã¨ã—ã¦å®šç¾©ã•ã‚Œã¦ã„ã‚‹
	userRepository repository.UserRepository
}

type UserUsecase interface {
	Login(model.User) (bool, error)
}

// userUsecaseã®ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿
func NewUserUsecase(userRepository repository.UserRepository) UserUsecase {
	return &userUsecase {
		userRepository: userRepository,
	}
}

func (userUsecase *userUsecase) Login(user model.User) (bool, error) {
    // ã“ã“ã§interfaceadapterå±¤ã®ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’ã‚¤ãƒ³ã‚¿ãƒ•ã‚§ãƒ¼ã‚¹ã‚’ä»‹ã—ã¦å‘¼ã³å‡ºã—ã¦ã„ã‚‹
	isLogin, err := userUsecase.userRepository.FindUser(user)
	if err != nil {
		return false, fmt.Errorf("calling useUsecase.userRepository.FindUser:%w", err)
	}

	return isLogin, nil
}
```

```Go

package repository

import (
	"fmt"
	"github.com/higuruchi/certification-app/internal/interfaceadapter/repository/worker"
	"github.com/higuruchi/certification-app/internal/usecase/model"

)

type UserRepository struct {
    // externalinterfaceå±¤ã®ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’å‘¼ã³å‡ºã™ãŸã‚ã®ã‚¤ãƒ³ã‚¿ãƒ•ã‚§ãƒ¼ã‚¹ãŒãƒ¡ãƒ³ãƒã¨ã—ã¦å®šç¾©ã•ã‚Œã¦ã„ã‚‹
	databaseHandler worker.DatabaseHandler
}

// UserRepositoryã®ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿
func NewUserRepository(
	databaseHandler worker.DatabaseHandler,
) *UserRepository {
	return &UserRepository{
		databaseHandler: databaseHandler,
	}
}

// SQLåˆ†ã‚’æ§‹ç¯‰ã—SQLã‚’å®Ÿè¡Œã™ã‚‹ãŸã‚externalinterfaceå±¤ã®ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’å‘¼ã³å‡ºã™ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«
func (userRepository *UserRepository) FindUser(user model.User) (bool, error) {
	sql := `
    SELECT CASE
		WHEN COUNT(*)=1 THEN 1
		ELSE 0
		END
    FROM users
    WHERE name=? AND password=?
`
	rows, err := userRepository.databaseHandler.Query(sql, user.Name, hashPassword(user.Password))
	defer rows.Close()
	if err != nil {
		return false, fmt.Errorf("calling userRepository.databaseHandler.Query: %w", err)
	}

	var isLogin int
	rows.Next()
	if err := rows.Scan(&isLogin); err != nil {
		return false, fmt.Errorf("calling rows.Scan: %w", err)
	}

	if isLogin == 0 {
		return false, nil
	}

	return true, nil
}
```