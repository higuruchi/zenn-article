---
title: "クリーンアーキテクチャとJWTを用いて認証アプリケーションを作ってみた"
emoji: "🐕"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: []
published: false
---

## アプリケーションの仕様

今回作成したアプリケーションはユーザ名とパスワードを含んだリクエストを受けると、ユーザ名とパスワードのペアが正しいか検証し、正しい場合はトークンを返すアプリケーションです。ソースコードは以下のリンクにあります。

https://github.com/higuruchi/certification-app

以下は実行時のデモです。

```bash
$ curl -w '\n' 'http://<IP Address>:<Port>/' --data 'name=higuruchi&password=pass' -XPOST
{"token":"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJhZG1pbiI6dHJ1ZSwiZXhwIjoxNjMxNjgxODk3fQ.YEWrN5T2rQyferN2kt2V3up3fW5N030jlDphkzXx7JU"}
$  curl -w '\n' 'http://<IP Address>:<Port>/' --data 'name=higuruchi&password=faultpass' -XPOST
{"message":"unauthorized"}
```

### 処理の流れ

![処理の流れを表す画像](../images/58a766398b9336/proces_flow.png)

## 使用技術

- Go 1.17
    - Echo(https://echo.labstack.com/)
    - Wire(https://github.com/google/wire)
- MySQL Ver 8.0.26

## クリーンアーキテクチャって？

クリーンアーキテクチャとは下図の通りExternal Interface・Interface Adapter・Usecase・Entityの4層になっており、それぞれの層を分離し、依存の流れを外から中だけの一方向にすることを目的としたアーキテクチャです。

![クリーンアーキテクチャを表す画像](../images/58a766398b9336/CleanArchitecture.jpeg)

## それぞれの層の解説

### Enterprise Business Rules

- アプリケーションのビジネスロジックを表現するEntityが所属するレイヤー

### Application Business Rules

- Entityが持つ振る舞いを表現するためのレイヤー
- Entityに所属するオブジェクトと協調しユースケースを達成する

### Interface Adapter

- Frameworks & Driversの層から来たデータを内側の層で扱えるデータの変換にする役割を果たす

### Frameworks & Drivers

- データベースの操作などの外部との連携の役割を果たす

## それぞれの層のソースコードの解説

## 実際に使ってみたメリット・デメリット

### メリット

- 内側の層は外側の層がどのような実装になっているかなどを気にしなくてよい実装になっているため、データベースなどのミドルウェアを変更した場合でも最小限の変更で済ますことができる

### デメリット

- 依存関係を解消するためのインターフェースを実装しなければならず、プログラム全体が複雑になり、ファイルやソースコードの行数も増加することがある


## JWTって？

JWTとはJSON Web Tokenの略称で、属性情報をJSONデータ構造で表現したトークンの仕様です。ヘッダ、ペイロード、署名の3つの要素から構成され、トークンを書き換えた場合、署名と照合することにより書き換えを検出することができます。

### JWTが生成される流れ

![](../images/58a766398b9336/JWT.png)

###　 Echoを用いたJWT生成の詳細